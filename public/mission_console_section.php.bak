<?php
/**
 * Backup of the Mission Console section that was removed from simulation.php.
 * This file preserves the original markup and JavaScript wiring in case we need to restore it later.
 */
?>

<section class="panel console-wrapper">
    <div>
        <h1>Mission Console</h1>
        <p>
            Practice reasoning through suspicious infrastructure by using this contained
            terminal. Nothing you type reaches a real machine&mdash;responses are scripted to
            reinforce investigative instincts.
        </p>
        <ul>
            <li>Use <code>help</code>, <code>ls</code>, <code>cat</code>, and <code>hint</code>.</li>
            <li>Find the safeguard phrase hidden in the logs.</li>
            <li><code>reset</code> will restore the sandbox.</li>
        </ul>
    </div>
    <div class="terminal-card">
        <div class="terminal-toolbar">
            <span class="indicator"></span>
            <span class="indicator yellow"></span>
            <span class="indicator green"></span>
            <span class="terminal-title">synthetic-node</span>
        </div>
        <div id="console-terminal" class="terminal-window" aria-label="Training terminal"></div>
    </div>
</section>

<script>
(() => {
    const FitAddonClass = window.FitAddon?.FitAddon || window.fitAddon?.FitAddon;
    const term = new window.Terminal({
        theme: {
            background: '#05060a',
            foreground: '#e2f3ff',
            cursor: '#00ffc6',
        },
        fontSize: 14,
        rows: 18,
        convertEol: false,
    });
    const container = document.getElementById('console-terminal');
    term.open(container);
    if (FitAddonClass) {
        const missionFit = new FitAddonClass();
        term.loadAddon(missionFit);
        missionFit.fit();
        window.addEventListener('resize', () => missionFit.fit());
    }
    const intro = [
        'Deepfake Defense :: Synthetic Node 77-B',
        'Type "help" to list training commands.'
    ];
    intro.forEach(line => term.writeln(line));

    const missionPrompt = '> ';
    let missionBuffer = '';
    const missionHistory = [];
    let missionHistoryIndex = 0;
    let missionRowsRendered = 0;

    const moveCursorToMissionStart = () => {
        if (missionRowsRendered > 0) {
            term.write(`\x1b[${missionRowsRendered}F`);
        }
        term.write('\r');
    };

    const clearMissionRendered = () => {
        moveCursorToMissionStart();
        for (let i = 0; i <= missionRowsRendered; i++) {
            term.write('\x1b[2K\r');
            if (i < missionRowsRendered) {
                term.write('\x1b[1B');
            }
        }
        if (missionRowsRendered > 0) {
            term.write(`\x1b[${missionRowsRendered}A`);
        }
    };

    const renderMissionLine = () => {
        clearMissionRendered();
        term.write(`${missionPrompt}${missionBuffer}`);
        const cols = term.cols || 80;
        missionRowsRendered = Math.floor((missionPrompt.length + missionBuffer.length) / cols);
    };

    const writeMissionPrompt = (prependNewline = false) => {
        missionBuffer = '';
        missionHistoryIndex = missionHistory.length;
        missionRowsRendered = 0;
        if (prependNewline) {
            term.write('\r\n');
        }
        term.write(missionPrompt);
    };

    writeMissionPrompt(false);

    term.onPaste?.((data) => {
        if (!data) return;
        missionBuffer += data.replace(/\r/g, '');
        renderMissionLine();
    });

    term.onKey(({key, domEvent}) => {
        const printable = !domEvent.altKey && !domEvent.ctrlKey && !domEvent.metaKey;
        if (domEvent.key === 'Enter') {
            domEvent.preventDefault();
            const commandText = missionBuffer;
            clearMissionRendered();
            term.write(`${missionPrompt}${commandText}\r\n`);
            const command = missionBuffer.trim();
            if (command.length === 0) {
                writeMissionPrompt(false);
                return;
            }
            missionHistory.push(command);
            missionHistoryIndex = missionHistory.length;
            window.fetch('/simulation.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({command, target: 'mission'}),
            })
                .then((resp) => resp.json())
                .then((data) => {
                    if (data.clear) {
                        term.clear();
                    }
                    if (data.output) {
                        term.writeln(data.output);
                    }
                    writeMissionPrompt(false);
                })
                .catch(() => {
                    term.writeln('Error: unable to reach the training host.');
                    writeMissionPrompt(false);
                });
        } else if (domEvent.key === 'Backspace') {
            domEvent.preventDefault();
            if (missionBuffer.length > 0) {
                missionBuffer = missionBuffer.slice(0, -1);
                renderMissionLine();
            }
        } else if (domEvent.key === 'ArrowUp') {
            domEvent.preventDefault();
            if (missionHistory.length === 0) {
                return;
            }
            if (missionHistoryIndex > 0) {
                missionHistoryIndex -= 1;
            }
            missionBuffer = missionHistory[missionHistoryIndex] ?? '';
            renderMissionLine();
        } else if (domEvent.key === 'ArrowDown') {
            domEvent.preventDefault();
            if (missionHistoryIndex < missionHistory.length - 1) {
                missionHistoryIndex += 1;
                missionBuffer = missionHistory[missionHistoryIndex] ?? '';
            } else {
                missionHistoryIndex = missionHistory.length;
                missionBuffer = '';
            }
            renderMissionLine();
        } else if ((domEvent.ctrlKey || domEvent.metaKey) && domEvent.key.toLowerCase() === 'c') {
            domEvent.preventDefault();
            clearMissionRendered();
            term.writeln('^C');
            writeMissionPrompt(false);
        } else if ((domEvent.ctrlKey || domEvent.metaKey) && domEvent.key.toLowerCase() === 'v') {
            if (navigator.clipboard?.readText) {
                navigator.clipboard.readText().then((text) => {
                    if (!text) return;
                    missionBuffer += text.replace(/\r/g, '');
                    renderMissionLine();
                }).catch(() => {});
            }
        } else if (printable && key.length === 1) {
            missionBuffer += key;
            renderMissionLine();
        }
    });
})();
</script>

